pipeline {
    agent any
    
    // Using a specific trigger that only activates for tags
    triggers {
        // Run only when explicitly triggered or by SCM changes matching our tag pattern
        pollSCM('H/5 * * * *')
    }

    options {
        // Discard old builds
        buildDiscarder(logRotator(numToKeepStr: '5'))
        // Skip default checkout to handle it in the first stage
        skipDefaultCheckout()
    }

    stages {
        stage('Checkout') {
            steps {
                // Explicit checkout to have more control
                checkout scm
            }
        }
        
        stage('Validate Build Trigger') {
            steps {
                script {
                    // Get tag information regardless of how Jenkins triggered the build
                    def gitCommit = sh(script: "git rev-parse HEAD", returnStdout: true).trim()
                    def gitTag = sh(script: "git tag --points-at ${gitCommit} | grep 'develop-' || echo ''", returnStdout: true).trim()
                    
                    echo "Current commit: ${gitCommit}"
                    echo "Tags on this commit: ${gitTag}"
                    
                    // Stop the pipeline if not building a develop-* tag
                    if (!gitTag || !gitTag.startsWith('develop-')) {
                        currentBuild.result = 'ABORTED'
                        error "This pipeline only runs for 'develop-*' tags. Aborting build."
                    }
                    
                    // Store tag info for later use
                    env.GIT_TAG = gitTag
                }
            }
        }

        stage('Info') {
            steps {
                echo "Estamos construyendo el tag: ${env.GIT_TAG}"
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "Desplegando un tag de desarrollo: ${env.GIT_TAG}"
                    // Aqu√≠ pones tus pasos para 'develop-'
                }
            }
        }
    }

    post {
        aborted {
            echo "Build aborted: This pipeline only runs for 'develop-*' tags."
        }
        failure {
            echo "Build failed! Check the logs for more information."
        }
        success {
            echo "Build completed successfully!"
        }
    }
}